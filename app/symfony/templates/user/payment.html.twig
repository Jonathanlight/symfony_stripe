{% extends 'base.html.twig' %}

{% block title %}Payment{% endblock %}

{% block body %}
    <!-- Icons Grid -->
    <section class="features-icons bg-light text-center">
        <div class="container">
            <div class="row">
                <div class="col">
                    <div class="card-body">
                        <form action="{{ path("subscription_paiement", {'id': product.id}) }}" method="post" id="payment-form">
                            <div class="form-row">
                                <div id="card-element">
                                </div>
                                <script src="https://js.stripe.com/v3/"></script>
                                <div id="card-errors" role="alert"></div>
                            </div>
                            <button class="btn btn-primary mt-4"> Acheter {{ product.price }}â‚¬</button>
                        </form>
                    </div>
                </div>
                <div class="col">
                    <div class="features-icons-item mx-auto mb-5 mb-lg-0 mb-lg-3">
                        <img src="{{ product.image }}" alt="..." class="img-thumbnail">
                        <h3> {{ product.name }} </h3>
                        <p>
                            {{ product.description }}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>
{% endblock %}



{% block javascripts %}
    <script>
        {% if app_environement == 'dev' %}
            var stripeToken = "{{ stripe_public_key_test }}";
        {% else %}
            var stripeToken = "{{ stripe_public_key_live }}";
        {% endif %}

        var stripe = Stripe(stripeToken);
        var elements = stripe.elements();
        var subscription = "{{ product.id }}";
        var clientSecret = "{{ intentSecret }}";
        var cardholderName = "{{ app.user.lastname ~' '~ app.user.firstname }}";

        var style = {
            base: {
                fontSize: '16px',
                color: "#32325d"
            }
        };

        var card = elements.create('card', {style: style});
        card.mount('#card-element');
        card.addEventListener('change', function(event) {
            var displayError = document.getElementById('card-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });

        var form = document.getElementById('payment-form');
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            stripe.handleCardPayment(
                clientSecret,
                card,
                {
                    payment_method_data: {
                        billing_details: { name: cardholderName },
                    },
                }
            ).then((result) => {
                if (result.error) {
                    // Display error.message in your UI.
                } else if ('paymentIntent' in result) {
                    stripeTokenHandler(result.paymentIntent);
                }
            });
        });

        function stripeTokenHandler(intent) {
            var form = document.getElementById('payment-form');
            var InputIntentID = document.createElement('input');
            var InputIntentPaymentMethod = document.createElement('input');
            var InputIntentStatus = document.createElement('input');
            var InputSubscription = document.createElement('input');

            InputIntentID.setAttribute('type', 'hidden');
            InputIntentID.setAttribute('name', 'stripeIntentId');
            InputIntentID.setAttribute('value', intent.id);

            InputIntentPaymentMethod.setAttribute('type', 'hidden');
            InputIntentPaymentMethod.setAttribute('name', 'stripeIntentPaymentMethod');
            InputIntentPaymentMethod.setAttribute('value', intent.payment_method);

            InputIntentStatus.setAttribute('type', 'hidden');
            InputIntentStatus.setAttribute('name', 'stripeIntentStatus');
            InputIntentStatus.setAttribute('value', intent.status);

            InputSubscription.setAttribute('type', 'hidden');
            InputSubscription.setAttribute('name', 'subscription');
            InputSubscription.setAttribute('value', subscription);

            form.appendChild(InputIntentID);
            form.appendChild(InputIntentPaymentMethod);
            form.appendChild(InputIntentStatus);
            form.appendChild(InputSubscription);
            form.submit();
        }
    </script>
{% endblock %}